<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Auth Guard: Redirects to login if not authenticated -->
    <script src="auth-guard.js"></script>
    <title>Transaction History</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous" />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .table-responsive {
        margin-top: 2rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav
      class="navbar navbar-expand-lg navbar-light sticky-top"
      style="background-color: #007bff">
      <div class="container-fluid">
        <a class="navbar-brand text-white" href="index.html"
          >Household Billing System</a
        >
      </div>
    </nav>

    <div class="container mt-5">
      <div class="row">
        <div class="col-12">
          <h1 class="mb-4">Transaction History</h1>
          <div id="loading" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div id="no-history" class="alert alert-info" style="display: none">
            You have no saved transactions.
          </div>
          <div class="table-responsive">
            <table
              class="table table-striped table-hover"
              id="history-table"
              style="display: none">
              <thead class="table-dark">
                <tr>
                  <th>Date</th>
                  <th>Bill Type</th>
                  <th>Description</th>
                  <th>Amount ($)</th>
                </tr>
              </thead>
              <tbody id="history-body">
                <!-- History rows will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("token");
        const historyBody = document.getElementById("history-body");
        const loadingDiv = document.getElementById("loading");
        const noHistoryDiv = document.getElementById("no-history");
        const historyTable = document.getElementById("history-table");

        try {
          const response = await fetch(
            "http://localhost:3001/api/bills/history",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "x-auth-token": token,
              },
            }
          );

          loadingDiv.style.display = "none";

          if (response.ok) {
            const bills = await response.json();
            if (bills.length === 0) {
              noHistoryDiv.style.display = "block";
            } else {
              historyTable.style.display = "table";
              bills.forEach((bill) => {
                const row = historyBody.insertRow();
                const formattedDate = new Date(bill.date).toLocaleDateString();
                const description =
                  bill.consumerName || bill.tenantName || "N/A";

                row.innerHTML = `
                  <td>${formattedDate}</td>
                  <td><span class="badge bg-primary">${
                    bill.billType
                  }</span></td>
                  <td>${description}</td>
                  <td>${bill.totalAmount.toFixed(2)}</td>
                `;
              });
            }
          } else {
            alert("Failed to load history.");
          }
        } catch (error) {
          loadingDiv.style.display = "none";
          alert("An error occurred while fetching history.");
          console.error("History fetch error:", error);
        }
      });
    </script>
  </body>
</html>
