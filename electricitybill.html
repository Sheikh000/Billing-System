<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Auth Guard: Redirects to login if not authenticated -->
    <script src="auth-guard.js"></script>
    <title>Calculate Electricity Bill</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Calculate Electricity Bill</h5>
            </div>
            <div class="card-body">
              <form id="billForm">
                <div class="mb-3">
                  <label for="meterNumber" class="form-label"
                    >Meter Number:</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="meterNumber"
                    name="meterNumber"
                    required />
                </div>
                <div class="mb-3">
                  <label for="consumerName" class="form-label"
                    >Consumer Name:</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="consumerName"
                    name="consumerName"
                    required />
                </div>
                <div class="mb-3">
                  <label for="month" class="form-label">Select Month:</label>
                  <input
                    type="date"
                    class="form-control"
                    id="month"
                    name="month"
                    required />
                </div>
                <div class="mb-3">
                  <label for="modeOfPayment" class="form-label"
                    >Mode of Payment:</label
                  >
                  <select
                    class="form-select"
                    id="modeOfPayment"
                    name="modeOfPayment"
                    required>
                    <option value="" selected disabled>
                      Select Mode of Payment
                    </option>
                    <option value="Paytm">Paytm</option>
                    <option value="Google Pay">Google Pay</option>
                    <option value="UPI">UPI</option>
                    <option value="Net Banking">Net Banking</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="units" class="form-label"
                    >Enter Number of Units Consumed:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="units"
                    name="units"
                    required />
                </div>
                <div class="mb-3">
                  <label for="rate" class="form-label"
                    >Enter Rate per Unit (in $):</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="rate"
                    name="rate"
                    required />
                </div>
              </form>

              <!-- Table to display bill information -->
              <div id="billDetails" class="mt-4" style="display: none">
                <h5>Electricity Bill Details</h5>
                <table class="table">
                  <tbody>
                    <tr>
                      <td><strong>Meter Number:</strong></td>
                      <td id="displayMeterNumber"></td>
                    </tr>
                    <tr>
                      <td><strong>Consumer Name:</strong></td>
                      <td id="displayConsumerName"></td>
                    </tr>
                    <tr>
                      <td><strong>Month:</strong></td>
                      <td id="displayMonth"></td>
                    </tr>
                    <tr>
                      <td><strong>Mode of Payment:</strong></td>
                      <td id="displayModeOfPayment"></td>
                    </tr>
                    <tr>
                      <td><strong>Units Consumed:</strong></td>
                      <td id="displayUnits"></td>
                    </tr>
                    <tr>
                      <td><strong>Rate per Unit ($):</strong></td>
                      <td id="displayRate"></td>
                    </tr>
                    <tr>
                      <td><strong>Total Bill Amount ($):</strong></td>
                      <td id="displayTotalAmount"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer text-end">
              <button
                type="button"
                class="btn btn-primary"
                onclick="calculateBill()">
                Calculate
              </button>
              <button
                type="button"
                class="btn btn-success"
                onclick="saveAndPrint()">
                Pay and Generate Invoice
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="refreshPage()">
                Calculate Again
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JavaScript Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>

    <script>
      function getBillData() {
        const meterNumber = document.getElementById("meterNumber").value;
        const consumerName = document.getElementById("consumerName").value;
        const month = document.getElementById("month").value;
        const modeOfPayment = document.getElementById("modeOfPayment").value;
        const units = parseFloat(document.getElementById("units").value);
        const rate = parseFloat(document.getElementById("rate").value);

        // Basic validation
        if (
          !meterNumber ||
          !consumerName ||
          !month ||
          !modeOfPayment ||
          isNaN(units) ||
          isNaN(rate)
        ) {
          alert("Please fill all fields correctly.");
          return null;
        }

        const totalAmount = units * rate;

        return {
          meterNumber,
          consumerName,
          month,
          modeOfPayment,
          units,
          rate,
          totalAmount,
        };
      }

      function calculateBill() {
        const billData = getBillData();
        if (!billData) return;

        // Display bill details in the table
        document.getElementById("displayMeterNumber").innerText =
          billData.meterNumber;
        document.getElementById("displayConsumerName").innerText =
          billData.consumerName;
        document.getElementById("displayMonth").innerText = billData.month;
        document.getElementById("displayModeOfPayment").innerText =
          billData.modeOfPayment;
        document.getElementById("displayUnits").innerText = billData.units;
        document.getElementById("displayRate").innerText = billData.rate;
        document.getElementById("displayTotalAmount").innerText =
          billData.totalAmount.toFixed(2);

        // Show the bill details table and hide the form
        document.getElementById("billForm").style.display = "none";
        document.getElementById("billDetails").style.display = "block";
      }

      async function saveAndPrint() {
        calculateBill(); // First, display the bill on the page
        const billData = getBillData();
        if (!billData) return;

        const token = localStorage.getItem("token");

        try {
          const response = await fetch(
            "http://localhost:3001/api/bills/electricity",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-auth-token": token,
              },
              body: JSON.stringify(billData),
            }
          );

          if (response.ok) {
            window.print(); // Print the page only after successful save
          } else {
            const error = await response.json();
            alert("Error saving bill: " + (error.msg || "Please try again."));
          }
        } catch (error) {
          console.error("Failed to save bill:", error);
          alert("Could not connect to the server to save the bill.");
        }
      }

      function refreshPage() {
        window.location.reload(); // Refresh the page
      }
    </script>
  </body>
</html>
